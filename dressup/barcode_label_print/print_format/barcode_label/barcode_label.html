<!-- Barcode Label Print Format - 45mm x 35mm Label -->
{% set template = frappe.get_doc("Barcode Label Template", doc.label_template) %}
{% set company = frappe.db.get_default("Company") %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

{% set vertical_gap = template.vertical_gap or 0 %}
{% set horizontal_gap = template.horizontal_gap or 0 %}
{% set top_margin = template.top_margin or 0 %}
{% set left_margin = template.left_margin or 0 %}
{% set font_size = template.font_size or 10 %}

<style>
    @page {
        margin: 0mm;
        size: {{ template.label_width }}mm {{ template.label_height }}mm;
    }

    body {
        margin: 0 !important;
        padding: 0 !important;
        background-color: #f5f7fa; /* Preview background */
    }

    .label-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center; /* Center labels in preview */
        padding: 5mm 0;
    }

    .barcode-label {
        width: {{ template.label_width }}mm;
        height: {{ template.label_height }}mm;
        min-width: {{ template.label_width }}mm; /* Prevent collapsing */
        min-height: {{ template.label_height }}mm;
        background: #fff;
        margin-bottom: 5mm; /* Gap between labels in preview */
        box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Visual aid in preview */
        page-break-after: always;
        overflow: hidden;
        position: relative;
        font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        color: #1a1a1a;
        padding: 2mm;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    @media print {
        body { background: transparent !important; }
        .label-wrapper { padding: 0 !important; display: block !important; }
        .barcode-label { 
            margin: 0 !important; 
            box-shadow: none !important;
            page-break-after: always;
        }
    }

    /* Company Name */
    .company-name {
        width: 100%;
        font-weight: 700;
        font-size: {{ font_size * 0.8 }}px;
        margin-bottom: 1mm;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Item Details */
    .item-details {
        width: 100%;
        margin-bottom: 1mm;
    }

    .item-name {
        font-size: {{ font_size * 0.8 }}px;
        font-weight: 500;
        line-height: 1.1;
    }

    /* Price Tag */
    .price-tag {
        font-weight: 700;
        font-size: {{ font_size * 1.2 }}px;
        margin: 0.5mm 0;
    }

    /* Barcode Section */
    .barcode-section {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 1mm;
    }

    .barcode-image {
        max-width: 95%;
        max-height: 8mm; /* Reduced slightly to fit better */
    }

    .barcode-text {
        font-size: {{ font_size * 0.6 }}px;
        margin-top: 0.5mm;
    }

    /* Print Optimizations */
    @media print {
        .barcode-label {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            background: #fff !important;
        }
        
        .price-tag {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>

<div class="label-wrapper">
    {% for item in doc.items %}
        {% set qty = item.qty if item.qty > 0 else 1 %}
        {% for i in range(qty) %}
            {% set code_value = item.item_code %}
            {% if item.batch_no %}{% set code_value = item.batch_no %}{% endif %}
            {% if item.serial_no %}{% set code_value = item.serial_no %}{% endif %}
            
            {% set barcode_image = get_barcode_base64(template.barcode_type, code_value) %}
            
            <div class="barcode-label">
                <!-- Company Name -->
                {% if template.include_company_name and company %}
                <div class="company-name">{{ company }}</div>
                {% endif %}

                <!-- Item Details -->
                <div class="item-details">
                    <!-- Item Code -->
                    {% if template.include_item_code and item.item_code %}
                    <div class="item-code">{{ item.item_code }}</div>
                    {% endif %}

                    <!-- Item Name -->
                    {% if template.include_item_name and item.item_name %}
                    <div class="item-name">{{ item.item_name }}</div>
                    {% endif %}
                </div>

                <!-- Price -->
                {% if template.include_price and item.price %}
                <div class="price-tag">
                    {{ frappe.format_value(item.price, {'fieldtype': 'Currency'}) }}
                </div>
                {% endif %}

                <!-- Barcode -->
                <div class="barcode-section">
                    {% if barcode_image %}
                    <img src="{{ barcode_image }}" class="barcode-image" alt="Barcode" />
                    {% endif %}
                    <div class="barcode-text">{{ code_value }}</div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>
