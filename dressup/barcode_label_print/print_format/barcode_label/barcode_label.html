<!-- Barcode Label Print Format - 45mm x 35mm Label -->
{% set template = frappe.get_doc("Barcode Label Template", doc.label_template) %}
{% set company = frappe.db.get_default("Company") %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

{% set vertical_gap = template.vertical_gap or 0 %}
{% set horizontal_gap = template.horizontal_gap or 0 %}
{% set top_margin = template.top_margin or 0 %}
{% set left_margin = template.left_margin or 0 %}
{% set font_size = template.font_size or 10 %}

<style>
    @page {
        margin: 0;
        padding: 0;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .label-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: {{ vertical_gap }}mm {{ horizontal_gap }}mm;
        padding-top: {{ top_margin }}mm;
        padding-left: {{ left_margin }}mm;
    }

    .barcode-label {
        width: {{ template.label_width }}mm;
        height: {{ template.label_height }}mm;
        background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
        page-break-inside: avoid;
        overflow: hidden;
        position: relative;
        font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        color: #1a1a1a;
        border: 1.5px solid #000;
        border-radius: 2mm;
        padding: 1.5mm;
        display: flex;
        flex-direction: column;
    }

    /* Company Name - Top Header */
    .company-name {
        text-align: center;
        font-weight: 700;
        font-size: {{ font_size * 0.9 }}px;
        color: #000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-bottom: 1mm;
        border-bottom: 0.8px solid #333;
        margin-bottom: 1mm;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Item Details Section */
    .item-details {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5mm;
        flex-shrink: 0;
    }

    .item-code {
        font-size: {{ font_size * 0.7 }}px;
        color: #555;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .item-name {
        font-size: {{ font_size * 0.85 }}px;
        font-weight: 600;
        text-align: center;
        color: #222;
        line-height: 1.2;
        max-height: 2.4em;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word;
    }

    /* Price Tag */
    .price-tag {
        background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
        color: #fff;
        font-weight: 700;
        font-size: {{ font_size * 1.3 }}px;
        padding: 1mm 3mm;
        border-radius: 1.5mm;
        text-align: center;
        margin: 1mm 0;
        letter-spacing: 0.5px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Barcode Section */
    .barcode-section {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 0;
    }

    .barcode-image {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .barcode-text {
        font-size: {{ font_size * 0.65 }}px;
        color: #666;
        margin-top: 0.5mm;
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
    }

    /* Print Optimizations */
    @media print {
        .barcode-label {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            background: #fff !important;
        }
        
        .price-tag {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>

<div class="label-wrapper">
    {% for item in doc.items %}
        {% set qty = item.qty if item.qty > 0 else 1 %}
        {% for i in range(qty) %}
            {% set code_value = item.item_code %}
            {% if item.batch_no %}{% set code_value = item.batch_no %}{% endif %}
            {% if item.serial_no %}{% set code_value = item.serial_no %}{% endif %}
            
            {% set barcode_image = get_barcode_base64(template.barcode_type, code_value) %}
            
            <div class="barcode-label">
                <!-- Company Name -->
                {% if template.include_company_name and company %}
                <div class="company-name">{{ company }}</div>
                {% endif %}

                <!-- Item Details -->
                <div class="item-details">
                    <!-- Item Code -->
                    {% if template.include_item_code and item.item_code %}
                    <div class="item-code">{{ item.item_code }}</div>
                    {% endif %}

                    <!-- Item Name -->
                    {% if template.include_item_name and item.item_name %}
                    <div class="item-name">{{ item.item_name }}</div>
                    {% endif %}
                </div>

                <!-- Price -->
                {% if template.include_price and item.price %}
                <div class="price-tag">
                    {{ frappe.format_value(item.price, {'fieldtype': 'Currency'}) }}
                </div>
                {% endif %}

                <!-- Barcode -->
                <div class="barcode-section">
                    {% if barcode_image %}
                    <img src="{{ barcode_image }}" class="barcode-image" alt="Barcode" />
                    {% endif %}
                    <div class="barcode-text">{{ code_value }}</div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>
