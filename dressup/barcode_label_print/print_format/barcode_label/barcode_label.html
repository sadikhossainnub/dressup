<!-- This is a Jinja2 template file for ERPNext/Frappe. CSS linting disabled due to template syntax. -->
{% set template = frappe.get_doc("Barcode Label Template", doc.label_template) %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

{% set vertical_gap = template.vertical_gap or 0 %}
{% set horizontal_gap = template.horizontal_gap or 0 %}
{% set top_margin = template.top_margin or 0 %}
{% set left_margin = template.left_margin or 0 %}

<style>
    .label-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: {{ vertical_gap }}mm {{ horizontal_gap }}mm;
        padding-top: {{ top_margin }}mm;
        padding-left: {{ left_margin }}mm;
        box-sizing: border-box;
    }

    .barcode-label {
        width: {{ template.label_width }}mm;
        height: {{ template.label_height }}mm;
        background: white;
        page-break-inside: avoid;
        box-sizing: border-box;
        overflow: hidden;
        position: relative;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #000000;
    }

    /* The main black box shown in the image */
    .content-box {
        border: 1.2pt solid #000000;
        width: 90%;
        height: 80%;
        margin-top: 10%; /* To account for the white space above in the image */
        margin-left: 2pt;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
    }

    .price-tag {
        border-right: 1.2pt solid #000000;
        border-bottom: 1.2pt solid #000000;
        width: fit-content;
        padding: 1px 4px;
        font-weight: 600;
        font-size: {{ (template.font_size or 10) * 1.1 }}px;
        line-height: 1.2;
    }

    .barcode-section {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2px;
    }

    .barcode-image {
        max-width: 95%;
        max-height: 60%;
        display: block;
    }

    .item-code-text {
        font-size: {{ (template.font_size or 10) * 0.8 }}px;
        margin-top: 1px;
        font-weight: 400;
        text-align: center;
    }
</style>

<div class="label-wrapper">
    {% for item in doc.items %}
        {% set qty = item.qty if item.qty > 0 else 1 %}
        {% for i in range(qty) %}
            {% set code_value = item.item_code %}
            {% if item.batch_no %}{% set code_value = item.batch_no %}{% endif %}
            {% if item.serial_no %}{% set code_value = item.serial_no %}{% endif %}
            
            {% set barcode_image = get_barcode_base64(template.barcode_type, code_value) %}
            
            <div class="barcode-label">
                <div class="content-box">
                    {% if template.include_price and item.price %}
                    <div class="price-tag">
                        {{ frappe.format_value(item.price, {'fieldtype': 'Currency'}) }}
                    </div>
                    {% endif %}

                    <div class="barcode-section">
                        {% if barcode_image %}
                            <img src='{{ barcode_image }}' class="barcode-image" />
                        {% endif %}
                        
                        {% if template.include_item_code %}
                            <div class="item-code-text">{{ code_value }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
</div>

